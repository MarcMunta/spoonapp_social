{% extends "social/layouts/base.html" %}

{% block title %}SpoonChat with {{ other_user.username }}{% endblock %}

{% block content %}
<div class="spoon-chat-container">
    <div class="row h-100 g-0">
        <div class="col-12">
            <div class="spoon-chat-detail">
                <!-- Chat Header -->
                <div class="spoon-chat-header-detail">
                    <a href="{% url 'chat_list' %}" class="spoon-back-btn" title="Back to chat list">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    
                    <div class="spoon-avatar-container me-3">
                        {% if other_user.profile.profile_picture %}
                        <img src="{{ other_user.profile.profile_picture.url }}" 
                             alt="Profile" 
                             class="spoon-avatar" 
                             style="width: 50px; height: 50px;"
                             onclick="window.location.href='{% url 'profile' other_user.username %}';"
                             title="View {{ other_user.username }}'s profile">
                        {% else %}
                        <img src="https://i.imgur.com/jNNT4LE.png" 
                             alt="Default" 
                             class="spoon-avatar" 
                             style="width: 50px; height: 50px;"
                             onclick="window.location.href='{% url 'profile' other_user.username %}';"
                             title="View {{ other_user.username }}'s profile">
                        {% endif %}
                        
                        {% if other_user.profile.online %}
                        <div class="spoon-online-badge"></div>
                        {% endif %}
                    </div>
                    
                    <div class="flex-grow-1">
                        <div class="fw-bold fs-5">{{ other_user.username }}</div>
                        {% if other_user.profile.online %}
                        <div class="spoon-status-indicator">Online now</div>
                        {% else %}
                        <small class="opacity-75">Last seen {{ other_user.profile.last_seen|timesince }} ago</small>
                        {% endif %}
                    </div>
                    
                    <a href="{% url 'home' %}" class="spoon-home-btn" title="Home">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
                
                <!-- Messages Area -->
                <div id="spoon-messages-area" class="spoon-messages-area">
                    {% for message in messages %}
                    <div class="d-flex {% if message.sender == user %}justify-content-end{% endif %} mb-3">
                        <div class="spoon-message-bubble {% if message.sender == user %}spoon-message-sent{% else %}spoon-message-received{% endif %}">
                            {% if message.story %}
                                {% if message.story.expires_at > now %}
                                    {% if '.mp4' in message.story.media_file.url or '.webm' in message.story.media_file.url or '.ogg' in message.story.media_file.url %}
                                    <video src="{{ message.story.media_file.url }}" class="w-100 mb-1" controls></video>
                                    {% else %}
                                    <img src="{{ message.story.media_file.url }}" class="w-100 mb-1" />
                                    {% endif %}
                                {% else %}
                                    <div class="text-muted small fst-italic mb-1">Historia no disponible</div>
                                {% endif %}
                            {% endif %}
                            <div>{{ message.content }}</div>
                            <div class="spoon-message-time">{{ message.sent_at|date:"H:i" }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Message Input -->
                <div class="spoon-input-area">
                    <form method="post" id="spoon-message-form" class="d-flex w-100 align-items-center gap-3">
                        {% csrf_token %}
                        <input type="text" name="content" id="spoon-message-input" 
                               class="spoon-message-input" placeholder="Share your food thoughts... 🍽️" required>
                        <button type="submit" class="spoon-send-button" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesArea = document.getElementById('spoon-messages-area');
    const messageForm = document.getElementById('spoon-message-form');
    const messageInput = document.getElementById('spoon-message-input');
    
    // Scroll to bottom with smooth animation
    function scrollToBottom() {
        messagesArea.scrollTo({
            top: messagesArea.scrollHeight,
            behavior: 'smooth'
        });
    }
    
    scrollToBottom();
    
    // Handle form submission
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        if (!content) return;
        
        const formData = new FormData(messageForm);
        
        // Add message to UI immediately with animation
        const messageDiv = document.createElement('div');
        messageDiv.className = 'd-flex justify-content-end mb-3';
        messageDiv.innerHTML = `
            <div class="spoon-message-bubble spoon-message-sent">
                <div>${content}</div>
                <div class="spoon-message-time">${new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false})}</div>
            </div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
        messageInput.value = '';
        
        // Send to server
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                messageDiv.remove();
                messageInput.value = content;
                showErrorMessage('Failed to send message. Try again!');
            }
        })
        .catch(error => {
            messageDiv.remove();
            messageInput.value = content;
            console.error('Error:', error);
            showErrorMessage('Connection error. Please check your internet!');
        });
    });
    
    // Show typing indicator simulation
    let typingTimeout;
    messageInput.addEventListener('input', function() {
        clearTimeout(typingTimeout);
        showTypingIndicator();
        
        typingTimeout = setTimeout(() => {
            hideTypingIndicator();
        }, 1000);
    });
    
    function showTypingIndicator() {
        if (!document.getElementById('typing-indicator')) {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'spoon-typing-indicator';
            typingDiv.innerHTML = `
                <div class="spoon-typing-dot"></div>
                <div class="spoon-typing-dot"></div>
                <div class="spoon-typing-dot"></div>
                <small class="ms-2 text-muted">Typing...</small>
            `;
            messagesArea.appendChild(typingDiv);
            scrollToBottom();
        }
    }
    
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    function showErrorMessage(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        errorDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
    
    // Load new messages periodically
    function loadNewMessages() {
        fetch('{% url "load_messages" chat.id %}')
        .then(response => response.json())
        .then(data => {
            const currentMessageCount = messagesArea.querySelectorAll('.spoon-message-bubble').length;
            if (data.messages.length > currentMessageCount) {
                const newMessages = data.messages.slice(currentMessageCount);
                newMessages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `d-flex ${msg.is_mine ? 'justify-content-end' : ''} mb-3`;
                    messageDiv.innerHTML = `
                        <div class="spoon-message-bubble ${msg.is_mine ? 'spoon-message-sent' : 'spoon-message-received'}">
                            <div>${msg.content}</div>
                            <div class="spoon-message-time">${msg.sent_at}</div>
                        </div>
                    `;
                    messagesArea.appendChild(messageDiv);
                });
                scrollToBottom();
            }
        })
        .catch(error => console.error('Error loading messages:', error));
    }
    
    // Check for new messages every 3 seconds
    setInterval(loadNewMessages, 3000);
    
    // Auto-focus input with delay for better UX
    setTimeout(() => {
        messageInput.focus();
    }, 500);
    
    // Add Enter key support
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
